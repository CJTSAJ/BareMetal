### 背景
目前主流的IO虚拟化框架：半虚拟化和SR-IOV。SR--IOV性能很好，但硬件会直接暴露给虚拟机，带来很多不利的后果，最严重的就是**虚拟机热迁移会很困难**，因为在SR-IOV框架下，很多**硬件状态对hypervisor是只读的**。而半虚拟化的热迁移十分简便，因为都是软件状态。

**bonding driver**：有人**用Linux Ethernet Bonding Driver来解决SR-IOV热迁移问题**。
Linux bonding 驱动**把多个网络接口设备捆绑为单个的网络接口设置来使用**，用于网络负载均衡及网络冗余。对于bonding的网络负载均衡是我们在文件服务器中常用到的，**比如把三块网卡，当做一块来用，解决一个IP地址，流量过大**，服务器网络压力过大的问题。
对于服务器来说，网络设备的稳定也是比较重要的，特别是网卡。在生产型的系统中，网卡的可靠性就更为重要了。bonding 也能为网卡提供冗余的支持。把多块网卡绑定到一个IP地址，**当一块网卡发生物理性损坏的情况下，另一块网卡自动启用，并提供正常的服务**。

此种驱动运用了热插拔的特性。在热迁移开始之前，**分配给虚拟机的VF会被解绑，取而代之的是一块半虚拟化的网卡**。在这之后，网络流量将会被这块虚拟网卡而非VF处理。

#### 1.1 半虚拟化
- 数据路径优化：对于半虚拟化I/O 来说，网络包在虚拟机与硬件之间传输时，需要被宿主机所干预。**零复制（Zero-Copy）**技术可以被用于优化这种数据传输。(传统的IO数据传输需要进行多次拷贝和上下文切换，零拷贝技术可以优化该)
- 事件路径优化：半虚拟化的IO会触发很多VM-Exit，性能损耗极大。在硬件层面，Intel开发了基于CPU的Posted Interrupt。在传统运行状态下，来了一个外部中断，**通过IPI使虚拟机Vm-exit->中断注入->Vm Entry中断响应**。Posted Interrupt 允许APIC中断直接注入到guest而不需要VM-Exit。

#### 1.3热迁移
在热迁移的过程中，虚拟机将会从一台物理主机无缝地移动到另一台物理主机。在数据中心或者集群环境中，管理员必须在多个服务器之间进行虚拟机的热迁移，以此来达到负载均衡，服务器维护和动态资源管理的目的。虚拟机的迁移主要着重于两个方面：**内存迁移与本地资源迁移**。最流行的内存迁移方案被称为pre-copy 内存迁移。**Pre-copy 内存迁移将被修改的内存页（即脏页）迭代地从源主机传输到目的主机**。**第一轮迁移将会把虚拟机中的所有内存页迁移到目的主机**。此时虚拟机仍然正常运行，内存页持续变化。从第二轮开始到第N-1 轮，虚拟机监视器仅仅把上一轮中产生的脏页传输到目的主机中。**而在最后一轮开始前，虚拟机将会被关闭**，第N 轮的传输将最后剩余的脏页传输到目的主机。

而在本地资源迁移方面，两个最受关注的问题在于**本地存储与网络设备的迁移**。(1)本地存储的迁移问题可以通过使用网络存储设备（Network Attached Storage, NAS）解决。具体来说，**源主机和目的主机使用同一个网络存储设备**，这样，真实数据并不需要从源主机传输到目的主机，而仅需要重置连接即可。(2)至于网络设备的迁移问题，可以通过传输网络设备的状态来解决。具体来说，在内存迁移之后，网络设备状态将会被传输，最后虚拟机将会在目的主机中被重启。

